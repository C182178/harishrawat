AWSTemplateFormatVersion: '2010-09-09'
Description: Create IAM user to communicate from SAS with S3
Parameters:
  pIamUserName:
    Type: String
    Description: IAM user
    Default: ""
  pUSerIDfromCloudTrail:
    Description:  IAM user to communicate from SAS with S3.
    Type: String
    Default: ""
  pFimGroupName:
    Type: String
    Description: FIM Group Name that used for IAM key management
    Default: ''
  pSnowRequestId:
    Type: String
    Description: Service now Change request ID.
    Default: ''
  pPolicyName:
    Type: String
    Description: Managed Policy name of S3 bucket.
    Default: ""
Resources:
  rIamUser:
    Type: "AWS::IAM::User"
    Properties: 
      UserName: !Ref pIamUserName
      PermissionsBoundary: !Sub 'arn:aws:iam::${AWS::AccountId}:policy/LZ-IAM-Boundary' 
      ManagedPolicyArns:
        - !Sub 'arn:aws:iam::${AWS::AccountId}:policy/${pPolicyName}'       
  rKeyGenerationAdminIAMPolicy:
    Type: "AWS::IAM::ManagedPolicy"
    Properties: 
        PolicyDocument:
            Version: '2012-10-17'
            Statement:
                - 
                 Action:
                   - 'iam:ListUsers'
                 Effect: Allow
                 Resource: '*'
                - 
                 Action:
                   - 'iam:GetUser'
                 Effect: Allow
                 Resource:
                   Fn::Join: ["", [ "arn:aws:iam::", Ref: "AWS::AccountId", ":user/", Ref: "pIamUserName" ] ]
                - 
                 Action:
                   - 'iam:CreateAccessKey'
                   - 'iam:DeleteAccessKey'
                   - 'iam:GetAccessKeyLastUsed'
                   - 'iam:ListAccessKeys'
                   - 'iam:UpdateAccessKey'
                 Effect: Allow
                 Resource: 
                    Fn::Join: ["", [ "arn:aws:iam::", Ref: "AWS::AccountId", ":user/", Ref: "pIamUserName" ] ]
                 Condition:
                    StringLike:
                       'aws:userid': !Ref pUSerIDfromCloudTrail
        ManagedPolicyName: !Join ['', ['Keys-', !Ref rIamUser] ]
        Roles:
          - !Ref pFimGroupName
    DependsOn: rIamUser